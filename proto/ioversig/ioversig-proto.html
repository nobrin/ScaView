<!DOCTYPE html>
<html>
<head>
  <title>I over Sigma(I)</title>
  <script type="text/javascript" src="js/ioversig.sca.js" embed="embed"></script>
  <script type="text/javascript" src="js/ioversig.shell.js" embed="embed"></script>
  <script type="text/javascript" src="js/ioversig.table.js" embed="embed"></script>
  <script type="text/javascript">
	window.addEventListener("load", function() {
		var drawWilsonPlot = function(sca) {
			// Wilson-plot-like calculation
			// X: (1 / 2d)^2
			// Y: ln(<I> / fx^2)
			if(!sca){ alert("Calculate, first!!"); return; }
			var rs = sca.splitToShellsByShells(200),
				intensity,
				getX = function(shell) { return Math.pow(1 / (2 * shell.getResolution()), 2); },
				getY = function(shell) {
					// 5 C + 1.35 N + 1.5 O + 8 H
					var fC = calcScatteringFactor(Atom_C, shell.getResolution()),
						fN = calcScatteringFactor(Atom_N, shell.getResolution()),
						fO = calcScatteringFactor(Atom_O, shell.getResolution()),
						fH = calcScatteringFactor(Atom_H, shell.getResolution()),
						fx = fC * 5 + fN * 1.35 + fO * 1.5 + fH * 8;
					return Math.log(shell.getAverageIntensity() / Math.pow(fx, 2));
				};
//			var getY = function(shell) { return Math.log(shell.getAverageIntensity()); };

			var minX = getX(rs[rs.length-1]),
				maxX = getX(rs[0]),
				minY, maxY;

			for(var i=0;i<rs.length;i++){
				var y = getY(rs[i]);
				if(i === 0){ maxY = minY = y; continue; }
				if(maxY < y){ maxY = y; continue; }
				if(minY > y){ minY = y; continue; }
			}
			var canvas = document.getElementById("canvas1");
			var w = canvas.width, h = canvas.height;
			var ctx = canvas.getContext("2d");
			ctx.fillStyle = "rgb(255,255,255)";
			ctx.fillRect(0, 0, 600, 400);
/*
			ctx.moveTo(45, 0);
			ctx.lineTo(45, 355);
			ctx.lineTo(600, 355);
			ctx.stroke();
			ctx.fillStyle = "red";
			ctx.font = "20px";
			ctx.fillText("ln", 10, 170);
			ctx.fillText("1/((2d)^2)", 250, 360);
 */
			ctx.beginPath();
			ctx.fillStyle = "black";
			var chk = false;
			for(var i=0;i<rs.length;i++){
				var x = ((getX(rs[i]) - minX) / (maxX - minX)) * 590 + 5;
				var y = 400 - (((getY(rs[i]) - minY) / (maxY - minY)) * 390 + 5);
				if(!chk){ ctx.moveTo(x, y); chk = true; }
				else{ ctx.lineTo(x, y); }
				ctx.fillRect(x - 1, y - 1, 2, 2);
			}
			ctx.stroke();
		};

		var drawFilmPlot = function(logShells) {
			var color = {crystalX:"red", crystalY:"blue", crystalZ:"green", mosaicity:"cyan"};
 			var canvas = document.getElementById("canvas2");
			canvas.width = logShells.films.length * 2;
			var w = canvas.width, h = canvas.height;
			var ctx = canvas.getContext("2d");
			ctx.fillStyle = "white";
			ctx.fillRect(0, 0, w, h);
			ctx.fillStyle = "black";
			for(var k in logShells.films[0]){
				ctx.beginPath();
				if(color.hasOwnProperty(k)){ ctx.fillStyle = ctx.strokeStyle = color[k]; }
				else{ ctx.fillStyle = ctx.strokeStyle = "black"; }
				for(var i=0;i<logShells.films.length;i++){
					var maxY = logShells.films.maxValue[k], minY = logShells.films.minValue[k];
					var x = i * 2;
					var y = h - ((h - 10) * ((logShells.films[i][k] - minY) / (maxY - minY)) + 5);
					if(x === 0){ ctx.moveTo(x, y); }
					else{ ctx.lineTo(x, y); }
					ctx.fillRect(x, y, 2, 2);
				}
				ctx.stroke();
			}
		};

		// from $CLIBD/atomsf.lib
		var Atom_H = {a1: 0.493002, a2: 0.322912, a3: 0.140191, a4: 0.040810, b1:10.510900, b2:26.125700, b3: 3.142360, b4:57.799698, c :  0.003038};
		var Atom_C = {a1: 2.310000, a2: 1.020000, a3: 1.588600, a4: 0.865000, b1:20.843899, b2:10.207500, b3: 0.568700, b4:51.651199, c :  0.215600};
		var Atom_N = {a1:12.212600, a2: 3.132200, a3: 2.012500, a4: 1.166300, b1: 0.005700, b2: 9.893300, b3:28.997499, b4: 0.582600, c :-11.528999};
		var Atom_O = {a1: 3.048500, a2: 2.286800, a3: 1.546300, a4: 0.867000, b1:13.277100, b2: 5.701100, b3: 0.323900, b4:32.908897, c :  0.250800};
		var calcScatteringFactor = function(atom, d) {
			var S2 = Math.pow(1 / (2 * d), 2);
			var fx = atom.a1 * Math.exp(-atom.b1 * S2)
				   + atom.a2 * Math.exp(-atom.b2 * S2)
				   + atom.a3 * Math.exp(-atom.b3 * S2)
				   + atom.a4 * Math.exp(-atom.b4 * S2)
				   + atom.c;
			return fx;
		};

		var oLogShells = null, oScaShells = null, oSca = null;
		document.getElementById("cmdOK").addEventListener("click", function(e) {
			var logLines = null,
				spanStatus = document.getElementById("spanStatus"),
				tblRes = new ResultTableDecorator(document.getElementById("tblResults")),
				tblLog = new LogTableDecorator(document.getElementById("tblLog"));

			var funcProcess = function() {
				// main process
				if(oSca === null){ spanStatus.textContent = "Log file has been read. Reading SCA file ..."; return; }
				if(logLines === null){ spanStatus.textContent = "SCA file has been read. Reading Log file ..."; return; }
				spanStatus.textContent = "Reading SCALEPACK files are finished. Processing ...";
				oLogShells = LogShells.fromScalepack(logLines);

				// adding absences to oSca and sorting
				for(var i=0;i<oLogShells.absenceLines.length;i++){ oSca.addReflection(oLogShells.absenceLines[i]); }
				oSca.sortReflections();
				oScaShells = ResolutionShells.fromSca(oSca, oLogShells);
				spanStatus.textContent = "Process done.";

				var s = oScaShells[oScaShells.length-1];
				for(var i=oLogShells.length-1;i>=0;i--){
					tblRes.addShell(oScaShells[i]);
					tblLog.addShell(oLogShells[i], oScaShells[i]);
				}

				tblRes.addTotal(oSca);
				tblLog.addTotal(oLogShells.total, oSca);
				document.getElementById("tdAllObservations").textContent = oLogShells.allObservations;
				document.getElementById("tdObservationsOver1").textContent = oLogShells.observationsOver1;
				spanStatus.textContent = "Plotting...";
				drawWilsonPlot(oSca);
				drawFilmPlot(oLogShells);
				spanStatus.textContent = "Ready";
			};

			spanStatus.textContent = "Start reading files ...";
			oLogShells = null, oScaShells = null, oSca = null;
			tblRes.clear();
			tblLog.clear();

			var scaFile = document.getElementById("fileSca").files[0];
			var readerSca = new FileReader();
			readerSca.onload = function(e) {
				var lines = e.target.result.trim().split("\n");
				oSca = new ScaFile(lines);
				funcProcess();
			};
			readerSca.readAsText(scaFile);

			var logFile = document.getElementById("fileLog").files[0];
			var readerLog = new FileReader();
			readerLog.onload = function(e) {
				logLines = e.target.result.trim().split("\n");
				funcProcess();
			};
			readerLog.readAsText(logFile);
		}, false);

		document.getElementById("cmdSave").addEventListener("click", function(e) {
			if(!oScaShells || !oSca){ alert("Calculate, first!!"); return; }
			var lines = ['"Lower","Upper","<I>","<sig(I)>","<I>/<sig(I)>","<I/sig(I)>","Count"'];
			var digits = 2;
			for(var i=oScaShells.length-1;i>=0;i--){ lines.push(oScaShells[i].toCSV(digits)); }
			var items = [0,0];
			items.push(oSca.getAverageIntensity().toFixed(digits));
			items.push(oSca.getAverageSigma().toFixed(digits));
			items.push((oSca.getAverageIntensity() / oSca.getAverageSigma()).toFixed(digits));
			items.push(oSca.getAverageIoverSigma().toFixed(digits));
			items.push(oSca.reflections.length);
			lines.push(items.join(","));
			location.href = "data:application/x-download," + encodeURIComponent(lines.join("\n") + "\n");
		}, false);
	}, false);
  </script>
  <style type="text/css">
  	h1 { border-bottom: 1px solid #000099; border-left: .5em solid #000099; margin: 5px 0; padding: 5px; }
  	h2 { margin: 5px 0; padding: 0; }
  	p { color: #666666; font-size: small; margin: 0.5em; }
  	.statistic-table { border-collapse: collapse; }
    .statistic-table td { border: 1px solid #9999ff; }
    .statistic-table tbody tr td, .statistic-table tfoot tr td { width: 4em; text-align: right; padding: 0 .5em; font-family: monospace; }
    .statistic-table tfoot tr td { font-weight: bold; background-color: #ccccff; }
    .statistic-table thead tr td { text-align: center; font-size: small; font-family: Arial, sans-serif; font-weight: bold; background-color: #ccccff; }
  </style>
</head>
<body>
  <h1>Calculating &lt;I/&sigma;(I)&gt; from <i>SCALEPACK</i></h1>
  <p>
    <strong>alpha-release(2011-12-26) by Nobuo OKAZAKI</strong><br/>
    This page requires File API implementation and may work on Firefox 4, Google Chrome 5(not tested), or upper.<br />
    This tool processes files locally and never sends any data to the web!!
  </p>
  <table>
    <tr><td>SCALEPACK .sca file</td><td><input type="file" id="fileSca" size="100" /></td></tr>
    <tr><td>SCALEPACK .log file</td><td><input type="file" id="fileLog" size="100" /></td></tr>
    <tr><td colspan="2"><input type="button" id="cmdOK" value="Calculate &lt;I/&sigma;(I)&gt;" /></td></tr>
  </table>
  <hr />
  <p style="font-weight:bold">Status: <span id="spanStatus" style="color:red">Ready</span></p>
  <h2>Calculated from SCALEPACK.sca</h2>
  <table id="tblResults" class="statistic-table">
    <thead>
      <tr>
        <td colspan="2">Range</td>
        <td rowspan="2">&lt;I&gt;</td><td rowspan="2">&lt;&sigma;(I)&gt;</td>
        <td rowspan="2">&lt;I&gt;/&lt;&sigma;(I)&gt;</td><td rowspan="2">&lt;I/&sigma;(I)&gt;</td>
        <td rowspan="2">Count</td>
      </tr>
      <tr><td>Lower</td><td>Upper</td></tr>
    </thead>
    <tfoot id="tfootResults"></tfoot>
    <tbody id="tbodyResults"></tbody>
  </table>
  <hr />
  <h2>Results from SCALEPACK.log</h2>
  <table class="statistic-table">
    <thead>
      <tr><td colspan="2">Observations</td></tr>
      <tr><td>All</td><td>Over 1</td></tr>
    </thead>
    <tbody>
      <tr><td id="tdAllObservations"></td><td id="tdObservationsOver1"></td></tr>
    </tbody>
  </table>
  <br />
  </table>
  <table id="tblLog" class="statistic-table">
    <thead>
      <tr>
        <td colspan="2">Range</td>
        <td colspan="2">&lt;I&gt;</td><td colspan="2">&lt;&sigma;(I)&gt;</td>
        <td colspan="2">&lt;I&gt;/&lt;&sigma;(I)&gt;</td>
        <td rowspan="2">Redun.</td><td colspan="2">R<sub>merge</sub></td>
        <td rowspan="2">Comp.<br />(%)</td>
        <td rowspan="2">Count</td>
      </tr>
      <tr>
        <td>Lower</td><td>Upper</td>
        <td>Val.</td><td style="color:red">Diff.</td>
        <td>Val.</td><td style="color:red">Diff.</td>
        <td>Val.</td><td style="color:red">Diff.</td>
        <td>Lin.</td><td>Sq.</td>
      </tr>
    </thead>
    <tfoot id="tfootLog"></tfoot>
    <tbody id="tbodyLog"></tbody>
  </table>
  <hr />
  <h2>Save the calculated table</h2>
  <p>Because of the limitation of browser, this can not name the file.</p>
  <input type="button" id="cmdSave" value="Save the table as CSV" />
  <hr />
  <h2>Wilson-like Plot</h2>
  <canvas id="canvas1" width="600" height="400" style="border:1px solid blue"></canvas>
  <hr />
  <h2>Film parameter</h2>
  <canvas id="canvas2" width="100" height="200" style="border:1px solid blue"></canvas>
</body>
</html>
