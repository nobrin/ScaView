<!DOCTYPE html>
<html>
<head>
  <title>I over Sigma(I)</title>
  <script type="text/javascript">
	window.addEventListener("load", function() {
		var hkl2resolution = function(cell, miller_index) {
			// Calculating resolution of indexed reflection.
			var sin = Math.sin, cos = Math.cos, pow = Math.pow;
			var A = cell[3] / 180.0 * Math.PI,
				B = cell[4] / 180.0 * Math.PI,
				G = cell[5] / 180.0 * Math.PI,
				a = cell[0] * 1, b = cell[1] * 1, c = cell[2] * 1,
				h = miller_index[0] * 1, k = miller_index[1] * 1, l = miller_index[2] * 1;
			var v1 = (pow(h, 2) / pow(a, 2)) * pow(sin(A), 2)
					+ (pow(k, 2) / pow(b, 2)) * pow(sin(B), 2)
					+ (pow(l, 2) / pow(c, 2)) * pow(sin(G), 2),
				v2 = ((2 * k * l) / (b * c)) * (cos(B) * cos(G) - cos(A)),
				v3 = ((2 * h * l) / (a * c)) * (cos(G) * cos(A) - cos(B)),
				v4 = ((2 * h * k) / (a * b)) * (cos(A) * cos(B) - cos(G)),
				v0 = 1 - pow(cos(A), 2) - pow(cos(B), 2) - pow(cos(G), 2) + 2 * cos(A) * cos(B) * cos(G),
				v = (v1 + v2 + v3 + v4) / v0,
				d = Math.sqrt(1 / v);
			return d;
		};

		// Reflection object
		function Reflection() {};
		Reflection.fromScaLine = function(line, cell) {
			var obj = new Reflection();
			obj._items = line.trim().split(/\s+/);
			obj._resolution = hkl2resolution(cell, obj.hkl);
			return obj;
		};
		Object.defineProperties(Reflection.prototype, {
			hkl			: { get: function() { return this._items.slice(0, 3); } },
			intensity	: { get: function() { return this._items[3] * 1; } },
			sigma		: { get: function() { return this._items[4] * 1; } },
			iOverSigma	: { get: function() { return this.intensity / this.sigma; } },
			resolution	: { get: function() { return this._resolution; } }
		});

		// Scalepack file object
		function ScaFile(lines) {
			var refl,
				cell = lines[2].trim().split(/\s+/).slice(0, 6);
			this.reflections = [];
			this.intensity = this.sigma = this.iOverSigma = 0;
			for(var i=3;i<lines.length;i++){
				refl = Reflection.fromScaLine(lines[i], cell);
				this.intensity += refl.intensity;
				this.sigma += refl.sigma;
				this.iOverSigma += refl.iOverSigma;
				this.reflections.push(refl);
			}
			this.reflections.sort(function(a, b) { return a.resolution - b.resolution; });
		}
		ScaFile.prototype.getAverageIntensity = function() { return this.intensity / this.reflections.length; };
		ScaFile.prototype.getAverageSigma = function() { return this.sigma / this.reflections.length; };
		ScaFile.prototype.getAverageIoverSigma = function() { return this.iOverSigma / this.reflections.length; };
		
		// Shell object
		function ShellRange() { this.reflections = []; }
		ShellRange.prototype.getLowerLimit = function() { return this.reflections[this.reflections.length - 1].resolution; };
		ShellRange.prototype.getUpperLimit = function() { return this.reflections[0].resolution; };
		ShellRange.prototype.getAverageIntensity = function() {
			var intensity = 0;
			for(var i=0;i<this.reflections.length;i++){ intensity += this.reflections[i].intensity; }
			return intensity / this.reflections.length;
		};
		ShellRange.prototype.getAverageSigma = function() {
			var sigma = 0;
			for(var i=0;i<this.reflections.length;i++){ sigma += this.reflections[i].sigma; }
			return sigma / this.reflections.length;
		};
		ShellRange.prototype.getIoverSigma = function() {
			var ios = 0;
			for(var i=0;i<this.reflections.length;i++){ ios += this.reflections[i].iOverSigma; }
			return ios / this.reflections.length;
		};
		
		// Shells
		function ResolutionShells() {}
		ResolutionShells.fromScalepack = function(logLines, sca) {
			var chk = false,
				shellCounts;
			for(var i=0;i<logLines.length;i++){
				if(logLines[i].indexOf("  Lower Upper      No. of reflections with given No. of observations") === 0){
					shellCounts = [];
					chk = true;
				}else if(chk) {
					if(logLines[i].indexOf("  limit limit     0     1     2     3     4") === 0){ continue; }
					if(logLines[i].indexOf(" All hkl") === 0){ chk = false; }
					else{ shellCounts.push(logLines[i].trim().split(/\s+/)[12] * 1); }
				}
			}
			shellCounts.reverse();
			var cnt = shellCounts.shift(),
				shells = [new ShellRange()];
			for(var n=0;n<sca.reflections.length;n++){
				shells[shells.length - 1].reflections.push(sca.reflections[n]);
				cnt--;
				if(cnt === 0 && shellCounts.length){
					shells.push(new ShellRange());
					cnt = shellCounts.shift();
				}
			}
			var obj = new ResolutionShells();
			obj.shells = shells;
			return obj;
		};
		
		document.getElementById("cmdOK").addEventListener("click", function(e) {
			var oSca = null, logLines = null,
				spanStatus = document.getElementById("spanStatus"),
				tbody = document.getElementById("tbodyResults"),
				tfoot = document.getElementById("tfootResults");

			var funcProcess = function() {
				// main process
				if(oSca === null){ spanStatus.textContent = "Log file has been read. Reading SCA file ..."; return; }
				if(logLines === null){ spanStatus.textContent = "SCA file has been read. Reading Log file ..."; return; }
				spanStatus.textContent = "Reading SCALEPACK files are finished. Processing ...";
				var oShells = ResolutionShells.fromScalepack(logLines, oSca);
				spanStatus.textContent = "Process done.";
				for(var i=oShells.shells.length - 1;i>=0;i--){
					var shell = oShells.shells[i];
					var tr = document.createElement("tr");
					for(var j=0;j<7;j++){ tr.appendChild(document.createElement("td")); }
					tr.childNodes[0].textContent = shell.getLowerLimit().toFixed(2);
					tr.childNodes[1].textContent = shell.getUpperLimit().toFixed(2);
					tr.childNodes[2].textContent = shell.getAverageIntensity().toFixed(1);
					tr.childNodes[3].textContent = shell.getAverageSigma().toFixed(1);
					tr.childNodes[4].textContent = (shell.getAverageIntensity() / shell.getAverageSigma()).toFixed(1);
					tr.childNodes[5].textContent = shell.getIoverSigma().toFixed(1);
					tr.childNodes[6].textContent = shell.reflections.length;
					tbody.appendChild(tr);
				}
				var tr = document.createElement("tr");
				for(var i=0;i<7;i++){ tr.appendChild(document.createElement("td")); }
				tr.childNodes[0].textContent = "All";
				tr.childNodes[2].textContent = oSca.getAverageIntensity().toFixed(1);
				tr.childNodes[3].textContent = oSca.getAverageSigma().toFixed(1);
				tr.childNodes[4].textContent = (oSca.getAverageIntensity() / oSca.getAverageSigma()).toFixed(1);
				tr.childNodes[5].textContent = oSca.getAverageIoverSigma().toFixed(1);
				tr.childNodes[6].textContent = oSca.reflections.length;
				tfoot.appendChild(tr);
				spanStatus.textContent = "Ready";
			};

			spanStatus.textContent = "Start reading files ...";
			while(tbody.childNodes.length){ tbody.removeChild(tbody.childNodes[0]); }
			while(tfoot.childNodes.length){ tfoot.removeChild(tfoot.childNodes[0]); }

			var scaFile = document.getElementById("fileSca").files[0];
			var readerSca = new FileReader();
			readerSca.onload = function(e) {
				var lines = e.target.result.trim().split("\n");
				oSca = new ScaFile(lines);
				funcProcess();
			};
			readerSca.readAsText(scaFile);

			var logFile = document.getElementById("fileLog").files[0];
			var readerLog = new FileReader();
			readerLog.onload = function(e) {
				logLines = e.target.result.trim().split("\n");
				funcProcess();
			};
			readerLog.readAsText(logFile);
		}, false);
	}, false);
  </script>
  <style type="text/css">
  	h1 { border-bottom: 1px solid #000099; border-left: .5em solid #000099; margin: 5px 0; padding: 5px; }
  	p { color: #666666; font-size: small; margin: 0.5em; }
  	#tblResults { border-collapse: collapse; }
    #tblResults td { border: 1px solid #9999ff; }
    #tbodyResults tr td, #tfootResults tr td { width: 4em; text-align: right; padding: 0 .5em; font-family: monospace; }
    #tfootResults tr td { font-weight: bold; background-color: #ccccff; }
    #tblResults thead tr td { text-align: center; font-size: small; font-family: Arial, sans-serif; font-weight: bold; background-color: #ccccff; }
  </style>
</head>
<body>
  <h1>Calculating &lt;I/&sigma;(I)&gt; from SCALEPACK</h1>
  <p>
    <strong>alpha-release(2011-12-21) by Nobuo OKAZAKI</strong><br/>
    This page requires File API implementation and may work on Firefox 4, Google Chrome 5(not tested), or upper.<br />
    This tool processes files locally and never sends any data to the web!!
  </p>
  <table>
    <tr><td>SCALEPACK .sca file</td><td><input type="file" id="fileSca" size="80" /></td></tr>
    <tr><td>SCALEPACK .log file</td><td><input type="file" id="fileLog" size="80" /></td></tr>
    <tr><td colspan="2"><input type="button" id="cmdOK" value="Calculate &lt;I/&sigma;(I)&gt;" /></td></tr>
  </table>
  <hr />
  <p style="font-weight:bold">Status: <span id="spanStatus" style="color:red">Ready</span></p>
  <table id="tblResults">
    <thead>
      <tr>
        <td colspan="2">Range</td><td rowspan="2">&lt;I&gt;</td><td rowspan="2">&lt;&sigma;(I)&gt;</td>
        <td rowspan="2">&lt;I&gt;/&lt;&sigma;(I)&gt;</td><td rowspan="2">&lt;I/&sigma;(I)&gt;</td>
        <td rowspan="2">Count</td>
      </tr>
      <tr><td>Lower</td><td>Upper</td></tr>
    </thead>
    <tfoot id="tfootResults"></tfoot>
    <tbody id="tbodyResults"></tbody>
  </table>
</body>
</html>
